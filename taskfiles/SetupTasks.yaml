---
version: "3"

vars:
  PROJECT_DIR:
    sh: "git rev-parse --show-toplevel"
  BIN_DIR: "/usr/local/bin"
  GIT_DIR: "${HOME}/_git"
  SCRIPTS_DIR: "{{.PROJECT_DIR}}/scripts"

includes:
  git:
    taskfile: "./GitTasks.yaml"
    internal: true

tasks:
  #   default:
  #     silent: true
  #     cmds:
  #       - task:

  shlib:
    desc: Add/Update portable shell functions
    silent: true
    cmds:
      - task git:clone-update -- -s https://github.com/client9/shlib.git -d {{.SHLIB_DEST}}
      - rm -f {{.SHLIB_EXEC}}
      # combine scripts in order, drop empty lines, and only use first shabang
      - |
        cat \
          {{.SHLIB_DEST}}/license.sh \
          {{.SHLIB_DEST}}/log.sh \
          {{.SHLIB_DEST}}/echoerr.sh \
          {{.SHLIB_DEST}}/assert.sh \
          {{.SHLIB_DEST}}/is_command.sh \
          {{.SHLIB_DEST}}/http_download.sh \
          {{.SHLIB_DEST}}/github_release.sh \
          {{.SHLIB_DEST}}/hash_md5.sh \
          {{.SHLIB_DEST}}/hash_sha256.sh \
          {{.SHLIB_DEST}}/uname_arch.sh \
          {{.SHLIB_DEST}}/uname_arch_check.sh \
          {{.SHLIB_DEST}}/uname_os.sh \
          {{.SHLIB_DEST}}/uname_os_check.sh \
          {{.SHLIB_DEST}}/untar.sh \
          {{.SHLIB_DEST}}/mktmpdir.sh \
          {{.SHLIB_DEST}}/license_end.sh \
        | grep -v "^$" \
        | sed '/^#!/d' \
        | sed -e $'1i\\\n#!/bin/sh\n' > {{.SHLIB_EXEC}}
      - chmod +x {{.SHLIB_EXEC}}
      - |
        echo "Setting root as owner -- this may require password."
        sudo chown root {{.SHLIB_EXEC}}
      - |
        set -- $(locale LC_MESSAGES)
        yesexpr="$1"; noexpr="$2"; yesword="$3"; noword="$4"
        read -r -p "Source 'shlib.sh' in your ~/.zshrc? (y/n)? [y] " choice
        choice=${choice:-"y"}
        if [[ "$choice" =~ $yesexpr ]]; then
          grep -q "source shlib.sh" ~/.zshrc || echo "source shlib.sh" >> ~/.zshrc
        fi
      # - grep -q "source shlib.sh" ~/.bashrc || echo "source shlib.sh" >> ~/.bashrc
    vars:
      SHLIB_DEST: "/tmp/shlib"
      SHLIB_EXEC: "{{.BIN_DIR}}/shlib.sh" # Or zsh functions
